define(["jquery","underscore","backbone","bootstrap","moment","bootbox","hbs!template/home","hbs!template/eventform","hbs!template/singleEvent","jquery.dtp","jquery.validate"],function(e,t,n,r,i,s,o,u,a){var f=function(t,n,r,i){e.ajax({url:"/server/web/"+t,method:n,data:r,dataType:"json",success:function(e){return i(e)}})},l=function(e){return JSON.parse(localStorage.getItem("event-"+e))},c=function(n){var r=!0;e.each(n.data,function(e,t){r=!1,console.log(n.data[e].start_datetime),n.data[e].start_datetime=i(n.data[e].start_datetime).format("YYYY-MM-DD HH:mm"),n.data[e].end_datetime=i(n.data[e].end_datetime).format("YYYY-MM-DD HH:mm"),localStorage.setItem("event-"+t.id,JSON.stringify(n.data[e]))});var s={events:n.data,noeventyet:r},u=o(s);return this.$el.html(u),t.defer(function(){p(r)}),this},h=function(t){f("events/"+t,"DELETE",{},function(n){e("tr[data-id="+t+"]").remove();var r=e("#table-event-list tbody tr").length>0?!1:!0;p(r)})},p=function(t){t?(e("#table-event-list").hide(),e(".noevent").show()):(e("#table-event-list").show(),e(".noevent").hide())},d=function(t){var n={event:l(t)};s.dialog({title:"Update Event",message:u(n),buttons:{success:{label:"Confirm",className:"btn-success",callback:function(n){e("#form-event-update").validate();if(!e("#form-event-update").valid())return!1;var r=e("#event-start-dt").val(),n=e("#event-end-dt").val(),o=e("#event-name").val(),u=e("#event-description").val(),a=i(n).isAfter(i(r));if(!a)return s.alert("Invalid event start and end time!"),!1;var l={name:o,description:u,start_datetime:r,end_datetime:n};return f("events/"+t,"PUT",l,function(n){if(n){var r=i(n.start_datetime).format("YYYY-MM-DD HH:mm"),o=i(n.end_datetime).format("YYYY-MM-DD HH:mm");e("tr[data-id="+t+"] .event-title").html(n.name),e("tr[data-id="+t+"] .event-date").html(r+" - "+o),e("tr[data-id="+t+"] .event-description").html(u)}return s.hideAll(),!0}),!1}},main:{label:"Close",className:"btn-default",callback:function(){return!0}}}}),e("#event-start-dt").datetimepicker({format:"Y-m-d H:i",step:20}),e("#event-end-dt").datetimepicker({format:"Y-m-d H:i",step:20})},v=function(){var t={};s.dialog({title:"New Event",message:u(t),buttons:{success:{label:"Create",className:"btn-success",callback:function(t){e("#form-event-update").validate();if(!e("#form-event-update").valid())return!1;var n=e("#event-start-dt").val(),t=e("#event-end-dt").val(),r=e("#event-name").val(),o=e("#event-description").val(),u=i(t).isAfter(i(n));if(!u)return s.alert("Invalid event start and end time!"),!1;var l={name:r,start_datetime:n,end_datetime:t,description:o};return f("events","POST",l,function(t){return t&&(e("#table-event-list tbody").append(a(t)),localStorage.setItem("event-"+t.id,JSON.stringify(t)),s.hideAll()),p(!1),!0}),!1}},main:{label:"Close",className:"btn-default",callback:function(){return!0}}}}),e("#event-start-dt").datetimepicker({format:"Y-m-d H:i",step:20}),e("#event-end-dt").datetimepicker({format:"Y-m-d H:i",step:20})},m=function(){},g=n.View.extend({events:{"click .btn-edit-event":"doEdit","click .btn-remove-event":"doRemove","click .btn-new-event":"doCreate"},doCreate:function(e){return v(),!1},doEdit:function(t){var n=e(t.target).closest("a").attr("data-id");return d(n),!1},doRemove:function(t){var n=e(t.target).closest("a").attr("data-id");return s.dialog({message:"Are you sure to remove this event?",title:"Removing Event..",buttons:{success:{label:"Cancle!",className:"btn-default",callback:function(){return!0}},danger:{label:"Remove",className:"btn-danger",callback:function(){h(n)}}}}),!1},render:c,initialize:m});return g});